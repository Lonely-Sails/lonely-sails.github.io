<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>数学函数加密工具</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 800px;
        width: 100%;
      }

      .title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 600;
      }

      .input-section {
        margin-bottom: 30px;
      }

      .input-label {
        display: block;
        margin-bottom: 10px;
        color: #555;
        font-weight: 500;
      }

      .input-field {
        width: 100%;
        padding: 12px 20px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        background: #f9f9f9;
      }

      .input-field:focus {
        outline: none;
        border-color: #667eea;
        background: white;
      }

      .textarea-field {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
      }

      .function-examples {
        margin-top: 8px;
        font-size: 14px;
        color: #666;
        background: #f0f4ff;
        padding: 10px;
        border-radius: 8px;
      }

      .function-examples strong {
        color: #667eea;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .encrypt-btn,
      .decrypt-btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .encrypt-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .decrypt-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .encrypt-btn:hover,
      .decrypt-btn:hover {
        transform: translateY(-2px);
      }

      .encrypt-btn:disabled,
      .decrypt-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .result-container {
        margin-top: 20px;
      }

      .result-box {
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 20px;
        background: #f9f9f9;
        margin-bottom: 15px;
      }

      .result-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }

      .result-content {
        font-family: "Courier New", monospace;
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        word-break: break-all;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }

      .copy-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        transition: background 0.3s ease;
      }

      .copy-btn:hover {
        background: #0056b3;
      }

      .copy-success {
        background: #28a745 !important;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #f5c6cb;
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        margin: 20px 0;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .steps-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        .action-buttons {
          flex-direction: column;
        }

        .steps-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">数学函数加密工具</h1>

      <div class="input-section">
        <label class="input-label">数学函数表达式</label>
        <input
          type="text"
          id="mathFunction"
          class="input-field"
          placeholder="例如: x*2+1, sin(x), x^2, etc."
        />
        <div class="function-examples">
          <strong>支持的函数:</strong> +, -, *, /, ^(幂), sin, cos, tan, log,
          sqrt, abs, floor, ceil<br />
          <strong>示例:</strong> x*2+1, sin(x*3.14/180), x^2+3*x-5, log(x+1)
        </div>
      </div>

      <div class="input-section">
        <label class="input-label">要加密/解密的文字</label>
        <textarea
          id="inputText"
          class="input-field textarea-field"
          placeholder="请输入要加密或解密的文字..."
        ></textarea>
      </div>

      <div class="action-buttons">
        <button id="encryptBtn" class="encrypt-btn">🔒 加密</button>
        <button id="decryptBtn" class="decrypt-btn">🔓 解密</button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>正在处理...</div>
      </div>

      <div class="result-container" id="resultContainer" style="display: none">
        <div class="steps-container">
          <div class="result-box">
            <div class="result-label">步骤1: Base64编码</div>
            <div class="result-content" id="base64Result"></div>
            <button class="copy-btn" onclick="copyToClipboard('base64Result')">
              复制
            </button>
          </div>

          <div class="result-box">
            <div class="result-label">步骤2: 凯撒加密结果</div>
            <div class="result-content" id="finalResult"></div>
            <button class="copy-btn" onclick="copyToClipboard('finalResult')">
              复制
            </button>
          </div>
        </div>
      </div>

      <div id="errorMessage" class="error-message" style="display: none"></div>
    </div>

    <script>
      const mathFunctionInput = document.getElementById("mathFunction");
      const inputTextArea = document.getElementById("inputText");
      const encryptBtn = document.getElementById("encryptBtn");
      const decryptBtn = document.getElementById("decryptBtn");
      const loading = document.getElementById("loading");
      const resultContainer = document.getElementById("resultContainer");
      const base64Result = document.getElementById("base64Result");
      const finalResult = document.getElementById("finalResult");
      const errorMessage = document.getElementById("errorMessage");

      // 数学函数解析器
      function evaluateMathFunction(expression, x) {
        try {
          // 检查表达式是否为空
          if (!expression || expression.trim() === "") {
            throw new Error(
              "数学表达式不能为空。请输入一个有效的数学表达式，例如：x*2+1 或 sin(x)"
            );
          }

          // 检查是否包含变量x
          if (!expression.toLowerCase().includes("x")) {
            throw new Error(
              "数学表达式必须包含变量 x。例如：x+1, x*2, sin(x) 等"
            );
          }

          // 替换数学函数
          let expr = expression
            .toLowerCase()
            .replace(/\^/g, "**") // 幂运算
            .replace(/sin/g, "Math.sin")
            .replace(/cos/g, "Math.cos")
            .replace(/tan/g, "Math.tan")
            .replace(/log/g, "Math.log")
            .replace(/sqrt/g, "Math.sqrt")
            .replace(/abs/g, "Math.abs")
            .replace(/floor/g, "Math.floor")
            .replace(/ceil/g, "Math.ceil")
            .replace(/x/g, x.toString());

          // 安全检查：只允许数字、运算符和Math函数
          const allowedPattern = /^[0-9+\-*/.()Math\s]+$/;
          const cleanExpr = expr.replace(
            /Math\.(sin|cos|tan|log|sqrt|abs|floor|ceil)/g,
            ""
          );
          if (!allowedPattern.test(cleanExpr)) {
            throw new Error(
              "数学表达式包含不支持的字符或函数。</br>支持的运算符：+ - * / ^ ( )</br>支持的函数：sin cos tan log sqrt abs floor ceil</br>请检查您的表达式格式"
            );
          }

          const result = eval(expr);

          // 检查计算结果是否有效
          if (isNaN(result) || !isFinite(result)) {
            throw new Error(
              "数学表达式计算结果无效（NaN 或无穷大）。</br>请检查表达式是否正确，例如避免除零、负数开方等情况"
            );
          }

          return Math.floor(Math.abs(result)) % 26; // 确保结果在0-25之间
        } catch (error) {
          if (error.message.includes("数学表达式")) {
            throw error; // 重新抛出我们自定义的错误
          }
          throw new Error(
            "数学表达式语法错误：" +
              error.message +
              "</br></br>请检查：</br>1. 括号是否匹配</br>2. 运算符是否正确</br>3. 函数名是否拼写正确</br></br>示例：x*2+1, sin(x*3.14/180), sqrt(x+1)"
          );
        }
      }

      // Base64编码
      function encodeBase64(text) {
        return btoa(unescape(encodeURIComponent(text)));
      }

      // Base64解码
      function decodeBase64(base64) {
        try {
          return decodeURIComponent(escape(atob(base64)));
        } catch (error) {
          throw new Error("Base64解码失败：输入的字符串不是有效的Base64格式");
        }
      }

      // 凯撒加密
      function caesarCipher(text, shifts) {
        return text
          .split("")
          .map((char, index) => {
            if (/[a-zA-Z]/.test(char)) {
              const shift = shifts[index % shifts.length];
              const isUpperCase = char === char.toUpperCase();
              const charCode = char.toLowerCase().charCodeAt(0) - 97;
              const shiftedCode = (charCode + shift) % 26;
              const shiftedChar = String.fromCharCode(shiftedCode + 97);
              return isUpperCase ? shiftedChar.toUpperCase() : shiftedChar;
            }
            return char;
          })
          .join("");
      }

      // 凯撒解密
      function caesarDecipher(text, shifts) {
        return text
          .split("")
          .map((char, index) => {
            if (/[a-zA-Z]/.test(char)) {
              const shift = shifts[index % shifts.length];
              const isUpperCase = char === char.toUpperCase();
              const charCode = char.toLowerCase().charCodeAt(0) - 97;
              const shiftedCode = (charCode - shift + 26) % 26;
              const shiftedChar = String.fromCharCode(shiftedCode + 97);
              return isUpperCase ? shiftedChar.toUpperCase() : shiftedChar;
            }
            return char;
          })
          .join("");
      }

      // 生成偏移量数组
      function generateShifts(mathExpression, textLength) {
        const shifts = [];
        for (let i = 0; i < textLength; i++) {
          const shift = evaluateMathFunction(mathExpression, i);
          shifts.push(shift);
        }
        return shifts;
      }

      // 加密函数
      function encrypt() {
        const mathExpression = mathFunctionInput.value.trim();
        const inputText = inputTextArea.value.trim();

        if (!mathExpression) {
          showError(
            "请输入数学表达式。</br></br>数学表达式用于生成加密偏移量，必须包含变量 x。</br>示例：x*2+1, sin(x), x^2+3*x-5"
          );
          return;
        }

        if (!inputText) {
          showError(
            "请输入要加密的文字。</br></br>可以输入任何文本内容，包括中文、英文、数字和特殊字符。"
          );
          return;
        }

        try {
          showLoading(true);
          hideError();

          // 步骤1: Base64编码
          const base64Encoded = encodeBase64(inputText);

          // 步骤2: 生成偏移量并进行凯撒加密
          const shifts = generateShifts(mathExpression, base64Encoded.length);
          const encrypted = caesarCipher(base64Encoded, shifts);

          // 显示结果
          base64Result.textContent = base64Encoded;
          finalResult.textContent = encrypted;

          showLoading(false);
          resultContainer.style.display = "block";
        } catch (error) {
          showLoading(false);
          showError(error.message);
        }
      }

      // 解密函数
      function decrypt() {
        const mathExpression = mathFunctionInput.value.trim();
        const inputText = inputTextArea.value.trim();

        if (!mathExpression) {
          showError(
            "请输入数学表达式。</br></br>解密时必须使用与加密时完全相同的数学表达式。</br>示例：x*2+1, sin(x), x^2+3*x-5"
          );
          return;
        }

        if (!inputText) {
          showError(
            "请输入要解密的密文。</br></br>密文应该是通过本工具加密生成的字符串，通常包含字母和数字。"
          );
          return;
        }

        // 检查输入是否像是有效的密文
        if (!/^[A-Za-z0-9+/=]+$/.test(inputText)) {
          showError(
            "输入的文本不像是有效的密文。</br></br>有效的密文应该只包含字母、数字和 +/= 字符。</br>请确认您输入的是通过本工具加密生成的密文。"
          );
          return;
        }

        try {
          showLoading(true);
          hideError();

          // 步骤1: 生成偏移量并进行凯撒解密
          const shifts = generateShifts(mathExpression, inputText.length);
          const decrypted = caesarDecipher(inputText, shifts);

          // 步骤2: Base64解码
          const base64Decoded = decodeBase64(decrypted);

          // 显示结果
          base64Result.textContent = decrypted;
          finalResult.textContent = base64Decoded;

          showLoading(false);
          resultContainer.style.display = "block";
        } catch (error) {
          showLoading(false);
          if (error.message.includes("Invalid character")) {
            showError(
              "Base64解码失败：密文格式不正确。</br></br>可能的原因：</br>1. 输入的不是有效的密文</br>2. 使用了错误的数学表达式</br>3. 密文在传输过程中被损坏</br></br>请检查输入的密文和数学表达式是否正确。"
            );
          } else if (error.message.includes("数学表达式")) {
            showError(error.message);
          } else {
            showError(
              "解密失败：" +
                error.message +
                "</br></br>请确认：</br>1. 数学表达式与加密时完全一致</br>2. 密文完整且未被修改</br>3. 密文是通过本工具生成的"
            );
          }
        }
      }

      // 复制到剪贴板
      async function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        if (!text || text.trim() === "") {
          showError("没有内容可以复制。请先进行加密或解密操作。");
          return;
        }

        try {
          await navigator.clipboard.writeText(text);

          // 找到对应的复制按钮
          const copyBtn = element.nextElementSibling;
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "复制成功!";
          copyBtn.classList.add("copy-success");

          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove("copy-success");
          }, 2000);
        } catch (err) {
          console.error("复制失败:", err);
          if (err.name === "NotAllowedError") {
            showError(
              "复制失败：浏览器不允许访问剪贴板。</br></br>解决方法：</br>1. 请手动选择文本并按 Ctrl+C (或 Cmd+C) 复制</br>2. 确保网页是通过 HTTPS 访问的</br>3. 检查浏览器权限设置"
            );
          } else {
            showError(
              "复制失败：" +
                err.message +
                "</br></br>请手动选择文本并使用 Ctrl+C (或 Cmd+C) 复制。"
            );
          }
        }
      }

      // 显示/隐藏加载状态
      function showLoading(show) {
        loading.style.display = show ? "block" : "none";
        encryptBtn.disabled = show;
        decryptBtn.disabled = show;
      }

      // 显示错误信息
      function showError(message) {
        errorMessage.innerHTML = message;
        errorMessage.style.display = "block";
        resultContainer.style.display = "none";
      }

      // 隐藏错误信息
      function hideError() {
        errorMessage.style.display = "none";
      }

      // 事件监听
      encryptBtn.addEventListener("click", encrypt);
      decryptBtn.addEventListener("click", decrypt);

      // 输入时隐藏错误信息
      mathFunctionInput.addEventListener("input", hideError);
      inputTextArea.addEventListener("input", hideError);
    </script>
  </body>
</html>
