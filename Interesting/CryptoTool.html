<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ•°å­¦å‡½æ•°åŠ å¯†å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 800px;
        width: 100%;
      }

      .title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 600;
      }

      .input-section {
        margin-bottom: 30px;
      }

      .input-label {
        display: block;
        margin-bottom: 10px;
        color: #555;
        font-weight: 500;
      }

      .input-field {
        width: 100%;
        padding: 12px 20px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        background: #f9f9f9;
      }

      .input-field:focus {
        outline: none;
        border-color: #667eea;
        background: white;
      }

      .textarea-field {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
      }

      .function-examples {
        margin-top: 8px;
        font-size: 14px;
        color: #666;
        background: #f0f4ff;
        padding: 10px;
        border-radius: 8px;
      }

      .function-examples strong {
        color: #667eea;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .encrypt-btn,
      .decrypt-btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .encrypt-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .decrypt-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .encrypt-btn:hover,
      .decrypt-btn:hover {
        transform: translateY(-2px);
      }

      .encrypt-btn:disabled,
      .decrypt-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .result-container {
        margin-top: 20px;
      }

      .result-box {
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 20px;
        background: #f9f9f9;
        margin-bottom: 15px;
      }

      .result-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }

      .result-content {
        font-family: "Courier New", monospace;
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        word-break: break-all;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }

      .copy-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        transition: background 0.3s ease;
      }

      .copy-btn:hover {
        background: #0056b3;
      }

      .copy-success {
        background: #28a745 !important;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #f5c6cb;
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        margin: 20px 0;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .steps-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        .action-buttons {
          flex-direction: column;
        }

        .steps-container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">æ•°å­¦å‡½æ•°åŠ å¯†å·¥å…·</h1>

      <div class="input-section">
        <label class="input-label">æ•°å­¦å‡½æ•°è¡¨è¾¾å¼</label>
        <input
          type="text"
          id="mathFunction"
          class="input-field"
          placeholder="ä¾‹å¦‚: x*2+1, sin(x), x^2, etc."
        />
        <div class="function-examples">
          <strong>æ”¯æŒçš„å‡½æ•°:</strong> +, -, *, /, ^(å¹‚), sin, cos, tan, log,
          sqrt, abs, floor, ceil<br />
          <strong>ç¤ºä¾‹:</strong> x*2+1, sin(x*3.14/180), x^2+3*x-5, log(x+1)
        </div>
      </div>

      <div class="input-section">
        <label class="input-label">è¦åŠ å¯†/è§£å¯†çš„æ–‡å­—</label>
        <textarea
          id="inputText"
          class="input-field textarea-field"
          placeholder="è¯·è¾“å…¥è¦åŠ å¯†æˆ–è§£å¯†çš„æ–‡å­—..."
        ></textarea>
      </div>

      <div class="action-buttons">
        <button id="encryptBtn" class="encrypt-btn">ğŸ”’ åŠ å¯†</button>
        <button id="decryptBtn" class="decrypt-btn">ğŸ”“ è§£å¯†</button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨å¤„ç†...</div>
      </div>

      <div class="result-container" id="resultContainer" style="display: none">
        <div class="steps-container">
          <div class="result-box">
            <div class="result-label">æ­¥éª¤1: Base64ç¼–ç </div>
            <div class="result-content" id="base64Result"></div>
            <button class="copy-btn" onclick="copyToClipboard('base64Result')">
              å¤åˆ¶
            </button>
          </div>

          <div class="result-box">
            <div class="result-label">æ­¥éª¤2: å‡¯æ’’åŠ å¯†ç»“æœ</div>
            <div class="result-content" id="finalResult"></div>
            <button class="copy-btn" onclick="copyToClipboard('finalResult')">
              å¤åˆ¶
            </button>
          </div>
        </div>
      </div>

      <div id="errorMessage" class="error-message" style="display: none"></div>
    </div>

    <script>
      const mathFunctionInput = document.getElementById("mathFunction");
      const inputTextArea = document.getElementById("inputText");
      const encryptBtn = document.getElementById("encryptBtn");
      const decryptBtn = document.getElementById("decryptBtn");
      const loading = document.getElementById("loading");
      const resultContainer = document.getElementById("resultContainer");
      const base64Result = document.getElementById("base64Result");
      const finalResult = document.getElementById("finalResult");
      const errorMessage = document.getElementById("errorMessage");

      // æ•°å­¦å‡½æ•°è§£æå™¨
      function evaluateMathFunction(expression, x) {
        try {
          // æ£€æŸ¥è¡¨è¾¾å¼æ˜¯å¦ä¸ºç©º
          if (!expression || expression.trim() === "") {
            throw new Error(
              "æ•°å­¦è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©ºã€‚è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ•°å­¦è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼šx*2+1 æˆ– sin(x)"
            );
          }

          // æ£€æŸ¥æ˜¯å¦åŒ…å«å˜é‡x
          if (!expression.toLowerCase().includes("x")) {
            throw new Error(
              "æ•°å­¦è¡¨è¾¾å¼å¿…é¡»åŒ…å«å˜é‡ xã€‚ä¾‹å¦‚ï¼šx+1, x*2, sin(x) ç­‰"
            );
          }

          // æ›¿æ¢æ•°å­¦å‡½æ•°
          let expr = expression
            .toLowerCase()
            .replace(/\^/g, "**") // å¹‚è¿ç®—
            .replace(/sin/g, "Math.sin")
            .replace(/cos/g, "Math.cos")
            .replace(/tan/g, "Math.tan")
            .replace(/log/g, "Math.log")
            .replace(/sqrt/g, "Math.sqrt")
            .replace(/abs/g, "Math.abs")
            .replace(/floor/g, "Math.floor")
            .replace(/ceil/g, "Math.ceil")
            .replace(/x/g, x.toString());

          // å®‰å…¨æ£€æŸ¥ï¼šåªå…è®¸æ•°å­—ã€è¿ç®—ç¬¦å’ŒMathå‡½æ•°
          const allowedPattern = /^[0-9+\-*/.()Math\s]+$/;
          const cleanExpr = expr.replace(
            /Math\.(sin|cos|tan|log|sqrt|abs|floor|ceil)/g,
            ""
          );
          if (!allowedPattern.test(cleanExpr)) {
            throw new Error(
              "æ•°å­¦è¡¨è¾¾å¼åŒ…å«ä¸æ”¯æŒçš„å­—ç¬¦æˆ–å‡½æ•°ã€‚</br>æ”¯æŒçš„è¿ç®—ç¬¦ï¼š+ - * / ^ ( )</br>æ”¯æŒçš„å‡½æ•°ï¼šsin cos tan log sqrt abs floor ceil</br>è¯·æ£€æŸ¥æ‚¨çš„è¡¨è¾¾å¼æ ¼å¼"
            );
          }

          const result = eval(expr);

          // æ£€æŸ¥è®¡ç®—ç»“æœæ˜¯å¦æœ‰æ•ˆ
          if (isNaN(result) || !isFinite(result)) {
            throw new Error(
              "æ•°å­¦è¡¨è¾¾å¼è®¡ç®—ç»“æœæ— æ•ˆï¼ˆNaN æˆ–æ— ç©·å¤§ï¼‰ã€‚</br>è¯·æ£€æŸ¥è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®ï¼Œä¾‹å¦‚é¿å…é™¤é›¶ã€è´Ÿæ•°å¼€æ–¹ç­‰æƒ…å†µ"
            );
          }

          return Math.floor(Math.abs(result)) % 26; // ç¡®ä¿ç»“æœåœ¨0-25ä¹‹é—´
        } catch (error) {
          if (error.message.includes("æ•°å­¦è¡¨è¾¾å¼")) {
            throw error; // é‡æ–°æŠ›å‡ºæˆ‘ä»¬è‡ªå®šä¹‰çš„é”™è¯¯
          }
          throw new Error(
            "æ•°å­¦è¡¨è¾¾å¼è¯­æ³•é”™è¯¯ï¼š" +
              error.message +
              "</br></br>è¯·æ£€æŸ¥ï¼š</br>1. æ‹¬å·æ˜¯å¦åŒ¹é…</br>2. è¿ç®—ç¬¦æ˜¯å¦æ­£ç¡®</br>3. å‡½æ•°åæ˜¯å¦æ‹¼å†™æ­£ç¡®</br></br>ç¤ºä¾‹ï¼šx*2+1, sin(x*3.14/180), sqrt(x+1)"
          );
        }
      }

      // Base64ç¼–ç 
      function encodeBase64(text) {
        return btoa(unescape(encodeURIComponent(text)));
      }

      // Base64è§£ç 
      function decodeBase64(base64) {
        try {
          return decodeURIComponent(escape(atob(base64)));
        } catch (error) {
          throw new Error("Base64è§£ç å¤±è´¥ï¼šè¾“å…¥çš„å­—ç¬¦ä¸²ä¸æ˜¯æœ‰æ•ˆçš„Base64æ ¼å¼");
        }
      }

      // å‡¯æ’’åŠ å¯†
      function caesarCipher(text, shifts) {
        return text
          .split("")
          .map((char, index) => {
            if (/[a-zA-Z]/.test(char)) {
              const shift = shifts[index % shifts.length];
              const isUpperCase = char === char.toUpperCase();
              const charCode = char.toLowerCase().charCodeAt(0) - 97;
              const shiftedCode = (charCode + shift) % 26;
              const shiftedChar = String.fromCharCode(shiftedCode + 97);
              return isUpperCase ? shiftedChar.toUpperCase() : shiftedChar;
            }
            return char;
          })
          .join("");
      }

      // å‡¯æ’’è§£å¯†
      function caesarDecipher(text, shifts) {
        return text
          .split("")
          .map((char, index) => {
            if (/[a-zA-Z]/.test(char)) {
              const shift = shifts[index % shifts.length];
              const isUpperCase = char === char.toUpperCase();
              const charCode = char.toLowerCase().charCodeAt(0) - 97;
              const shiftedCode = (charCode - shift + 26) % 26;
              const shiftedChar = String.fromCharCode(shiftedCode + 97);
              return isUpperCase ? shiftedChar.toUpperCase() : shiftedChar;
            }
            return char;
          })
          .join("");
      }

      // ç”Ÿæˆåç§»é‡æ•°ç»„
      function generateShifts(mathExpression, textLength) {
        const shifts = [];
        for (let i = 0; i < textLength; i++) {
          const shift = evaluateMathFunction(mathExpression, i);
          shifts.push(shift);
        }
        return shifts;
      }

      // åŠ å¯†å‡½æ•°
      function encrypt() {
        const mathExpression = mathFunctionInput.value.trim();
        const inputText = inputTextArea.value.trim();

        if (!mathExpression) {
          showError(
            "è¯·è¾“å…¥æ•°å­¦è¡¨è¾¾å¼ã€‚</br></br>æ•°å­¦è¡¨è¾¾å¼ç”¨äºç”ŸæˆåŠ å¯†åç§»é‡ï¼Œå¿…é¡»åŒ…å«å˜é‡ xã€‚</br>ç¤ºä¾‹ï¼šx*2+1, sin(x), x^2+3*x-5"
          );
          return;
        }

        if (!inputText) {
          showError(
            "è¯·è¾“å…¥è¦åŠ å¯†çš„æ–‡å­—ã€‚</br></br>å¯ä»¥è¾“å…¥ä»»ä½•æ–‡æœ¬å†…å®¹ï¼ŒåŒ…æ‹¬ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ã€‚"
          );
          return;
        }

        try {
          showLoading(true);
          hideError();

          // æ­¥éª¤1: Base64ç¼–ç 
          const base64Encoded = encodeBase64(inputText);

          // æ­¥éª¤2: ç”Ÿæˆåç§»é‡å¹¶è¿›è¡Œå‡¯æ’’åŠ å¯†
          const shifts = generateShifts(mathExpression, base64Encoded.length);
          const encrypted = caesarCipher(base64Encoded, shifts);

          // æ˜¾ç¤ºç»“æœ
          base64Result.textContent = base64Encoded;
          finalResult.textContent = encrypted;

          showLoading(false);
          resultContainer.style.display = "block";
        } catch (error) {
          showLoading(false);
          showError(error.message);
        }
      }

      // è§£å¯†å‡½æ•°
      function decrypt() {
        const mathExpression = mathFunctionInput.value.trim();
        const inputText = inputTextArea.value.trim();

        if (!mathExpression) {
          showError(
            "è¯·è¾“å…¥æ•°å­¦è¡¨è¾¾å¼ã€‚</br></br>è§£å¯†æ—¶å¿…é¡»ä½¿ç”¨ä¸åŠ å¯†æ—¶å®Œå…¨ç›¸åŒçš„æ•°å­¦è¡¨è¾¾å¼ã€‚</br>ç¤ºä¾‹ï¼šx*2+1, sin(x), x^2+3*x-5"
          );
          return;
        }

        if (!inputText) {
          showError(
            "è¯·è¾“å…¥è¦è§£å¯†çš„å¯†æ–‡ã€‚</br></br>å¯†æ–‡åº”è¯¥æ˜¯é€šè¿‡æœ¬å·¥å…·åŠ å¯†ç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œé€šå¸¸åŒ…å«å­—æ¯å’Œæ•°å­—ã€‚"
          );
          return;
        }

        // æ£€æŸ¥è¾“å…¥æ˜¯å¦åƒæ˜¯æœ‰æ•ˆçš„å¯†æ–‡
        if (!/^[A-Za-z0-9+/=]+$/.test(inputText)) {
          showError(
            "è¾“å…¥çš„æ–‡æœ¬ä¸åƒæ˜¯æœ‰æ•ˆçš„å¯†æ–‡ã€‚</br></br>æœ‰æ•ˆçš„å¯†æ–‡åº”è¯¥åªåŒ…å«å­—æ¯ã€æ•°å­—å’Œ +/= å­—ç¬¦ã€‚</br>è¯·ç¡®è®¤æ‚¨è¾“å…¥çš„æ˜¯é€šè¿‡æœ¬å·¥å…·åŠ å¯†ç”Ÿæˆçš„å¯†æ–‡ã€‚"
          );
          return;
        }

        try {
          showLoading(true);
          hideError();

          // æ­¥éª¤1: ç”Ÿæˆåç§»é‡å¹¶è¿›è¡Œå‡¯æ’’è§£å¯†
          const shifts = generateShifts(mathExpression, inputText.length);
          const decrypted = caesarDecipher(inputText, shifts);

          // æ­¥éª¤2: Base64è§£ç 
          const base64Decoded = decodeBase64(decrypted);

          // æ˜¾ç¤ºç»“æœ
          base64Result.textContent = decrypted;
          finalResult.textContent = base64Decoded;

          showLoading(false);
          resultContainer.style.display = "block";
        } catch (error) {
          showLoading(false);
          if (error.message.includes("Invalid character")) {
            showError(
              "Base64è§£ç å¤±è´¥ï¼šå¯†æ–‡æ ¼å¼ä¸æ­£ç¡®ã€‚</br></br>å¯èƒ½çš„åŸå› ï¼š</br>1. è¾“å…¥çš„ä¸æ˜¯æœ‰æ•ˆçš„å¯†æ–‡</br>2. ä½¿ç”¨äº†é”™è¯¯çš„æ•°å­¦è¡¨è¾¾å¼</br>3. å¯†æ–‡åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«æŸå</br></br>è¯·æ£€æŸ¥è¾“å…¥çš„å¯†æ–‡å’Œæ•°å­¦è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®ã€‚"
            );
          } else if (error.message.includes("æ•°å­¦è¡¨è¾¾å¼")) {
            showError(error.message);
          } else {
            showError(
              "è§£å¯†å¤±è´¥ï¼š" +
                error.message +
                "</br></br>è¯·ç¡®è®¤ï¼š</br>1. æ•°å­¦è¡¨è¾¾å¼ä¸åŠ å¯†æ—¶å®Œå…¨ä¸€è‡´</br>2. å¯†æ–‡å®Œæ•´ä¸”æœªè¢«ä¿®æ”¹</br>3. å¯†æ–‡æ˜¯é€šè¿‡æœ¬å·¥å…·ç”Ÿæˆçš„"
            );
          }
        }
      }

      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      async function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        if (!text || text.trim() === "") {
          showError("æ²¡æœ‰å†…å®¹å¯ä»¥å¤åˆ¶ã€‚è¯·å…ˆè¿›è¡ŒåŠ å¯†æˆ–è§£å¯†æ“ä½œã€‚");
          return;
        }

        try {
          await navigator.clipboard.writeText(text);

          // æ‰¾åˆ°å¯¹åº”çš„å¤åˆ¶æŒ‰é’®
          const copyBtn = element.nextElementSibling;
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "å¤åˆ¶æˆåŠŸ!";
          copyBtn.classList.add("copy-success");

          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove("copy-success");
          }, 2000);
        } catch (err) {
          console.error("å¤åˆ¶å¤±è´¥:", err);
          if (err.name === "NotAllowedError") {
            showError(
              "å¤åˆ¶å¤±è´¥ï¼šæµè§ˆå™¨ä¸å…è®¸è®¿é—®å‰ªè´´æ¿ã€‚</br></br>è§£å†³æ–¹æ³•ï¼š</br>1. è¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¹¶æŒ‰ Ctrl+C (æˆ– Cmd+C) å¤åˆ¶</br>2. ç¡®ä¿ç½‘é¡µæ˜¯é€šè¿‡ HTTPS è®¿é—®çš„</br>3. æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®"
            );
          } else {
            showError(
              "å¤åˆ¶å¤±è´¥ï¼š" +
                err.message +
                "</br></br>è¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¹¶ä½¿ç”¨ Ctrl+C (æˆ– Cmd+C) å¤åˆ¶ã€‚"
            );
          }
        }
      }

      // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
      function showLoading(show) {
        loading.style.display = show ? "block" : "none";
        encryptBtn.disabled = show;
        decryptBtn.disabled = show;
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        errorMessage.innerHTML = message;
        errorMessage.style.display = "block";
        resultContainer.style.display = "none";
      }

      // éšè—é”™è¯¯ä¿¡æ¯
      function hideError() {
        errorMessage.style.display = "none";
      }

      // äº‹ä»¶ç›‘å¬
      encryptBtn.addEventListener("click", encrypt);
      decryptBtn.addEventListener("click", decrypt);

      // è¾“å…¥æ—¶éšè—é”™è¯¯ä¿¡æ¯
      mathFunctionInput.addEventListener("input", hideError);
      inputTextArea.addEventListener("input", hideError);
    </script>
  </body>
</html>
