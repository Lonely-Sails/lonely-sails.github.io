<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>座位抽取工具</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 900px;
        width: 100%;
      }

      .title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 600;
      }

      .description {
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
        text-align: center;
      }

      .classroom-container {
        position: relative;
        margin: 0 auto 30px;
        width: 100%;
        max-width: 800px;
      }

      .classroom {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        grid-template-rows: repeat(8, 1fr);
        gap: 8px;
        position: relative;
        width: 100%;
        aspect-ratio: 10/8;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
        border: 2px solid #ddd;
      }

      .seat {
        background-color: #667eea;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        user-select: none;
        font-size: 0.8rem;
      }

      .seat:hover {
        background-color: #5a6fd8;
      }

      .seat.skipped {
        background-color: #e74c3c;
        opacity: 0.7;
      }

      .seat.selected {
        background-color: #2ecc71;
        transform: scale(1.05);
        box-shadow: 0 0 0 3px #2ecc71;
        z-index: 2;
      }

      .slider {
        position: absolute;
        top: 0;
        left: 0;
        width: calc(10% - 8px);
        height: calc(12.5% - 8px);
        background-color: rgba(255, 255, 255, 0.2);
        border: 3px solid #F8CF01;
        border-radius: 6px;
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 5;
        pointer-events: none;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
      }

      button {
        padding: 15px 20px;
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      #startBtn {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      }

      #stopBtn {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }

      #resetBtn {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      }

      #settingsBtn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      /* 弹窗样式 */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
      }

      .close-btn {
        background: #ff4757;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
      }

      .close-btn:hover {
        background: #ff3742;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
        font-size: 16px;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        background: #f9f9f9;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
      }

      .form-help {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }

      .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
      }

      .btn-cancel {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .btn-confirm {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .btn-cancel:hover,
      .btn-confirm:hover {
        transform: translateY(-2px);
      }

      .current-seat {
        font-size: 1.4rem;
        font-weight: 600;
        color: #333;
        margin: 20px 0;
        padding: 15px;
        background-color: #f0f4ff;
        border-radius: 10px;
        border: 2px solid #ddd;
      }

      .status {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
      }

      .color-box {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      .normal {
        background-color: #667eea;
      }

      .skipped {
        background-color: #e74c3c;
      }

      .selected {
        background-color: #2ecc71;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        .title {
          font-size: 24px;
        }

        .classroom {
          gap: 6px;
          padding: 10px;
        }

        .seat {
          font-size: 0.7rem;
        }

        button {
          padding: 12px 16px;
          font-size: 14px;
        }

        .current-seat {
          font-size: 1.2rem;
        }

        .controls {
          flex-direction: column;
        }

        .modal-content {
          width: 95%;
          padding: 20px;
        }

        .modal-title {
          font-size: 20px;
        }

        .modal-actions {
          flex-direction: column;
        }

        .btn-cancel,
        .btn-confirm {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">座位抽取工具</h1>
      <p class="description">
        点击座位可标记为跳过，随机抽取时将不会选中这些座位
      </p>

      <div class="classroom-container">
        <div class="classroom" id="classroom">
          <!-- 座位将由JavaScript生成 -->
          <div class="slider" id="slider"></div>
        </div>
      </div>

      <div class="current-seat" id="currentSeat">等待抽取</div>

      <div class="controls">
        <button id="startBtn">开始抽取</button>
        <button id="stopBtn">停止抽取</button>
        <button id="resetBtn">重置跳过</button>
        <button id="settingsBtn">⚙️ 设置</button>
      </div>

      <div class="status">
        <div class="status-item">
          <div class="color-box normal"></div>
          <span>正常座位</span>
        </div>
        <div class="status-item">
          <div class="color-box skipped"></div>
          <span>跳过座位</span>
        </div>
        <div class="status-item">
          <div class="color-box selected"></div>
          <span>选中座位</span>
        </div>
      </div>
    </div>

    <!-- 设置弹窗 -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">座位设置</h2>
          <button id="closeModal" class="close-btn">×</button>
        </div>

        <div class="form-group">
          <label class="form-label" for="rowsInput">行数（高度）</label>
          <input
            type="number"
            id="rowsInput"
            class="form-input"
            min="3"
            max="15"
            value="8"
          />
          <div class="form-help">建议范围：3-15行</div>
        </div>

        <div class="form-group">
          <label class="form-label" for="colsInput">列数（宽度）</label>
          <input
            type="number"
            id="colsInput"
            class="form-input"
            min="3"
            max="20"
            value="10"
          />
          <div class="form-help">建议范围：3-20列</div>
        </div>

        <div class="modal-actions">
          <button id="cancelSettings" class="btn-cancel">取消</button>
          <button id="confirmSettings" class="btn-confirm">确认</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const classroom = document.getElementById("classroom");
        const slider = document.getElementById("slider");
        const currentSeatElement = document.getElementById("currentSeat");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const resetBtn = document.getElementById("resetBtn");
        const settingsBtn = document.getElementById("settingsBtn");

        // 弹窗相关元素
        const settingsModal = document.getElementById("settingsModal");
        const closeModal = document.getElementById("closeModal");
        const cancelSettings = document.getElementById("cancelSettings");
        const confirmSettings = document.getElementById("confirmSettings");
        const rowsInput = document.getElementById("rowsInput");
        const colsInput = document.getElementById("colsInput");

        let rows = 8;
        let cols = 10;
        let seats = [];
        let skippedSeats = new Set();
        let intervalId = null;
        let currentSeat = null;

        // 加载保存的状态
        function loadSavedState() {
          const savedData = localStorage.getItem('seatRandomizerState');
          if (savedData) {
            try {
              const data = JSON.parse(savedData);
              if (data.rows && data.cols) {
                rows = data.rows;
                cols = data.cols;
              }
              if (data.skippedSeats) {
                skippedSeats = new Set(data.skippedSeats);
              }
            } catch (e) {
              console.log('加载保存状态失败:', e);
            }
          }
        }

        // 保存当前状态
        function saveState() {
          const stateData = {
            rows: rows,
            cols: cols,
            skippedSeats: Array.from(skippedSeats)
          };
          localStorage.setItem('seatRandomizerState', JSON.stringify(stateData));
        }

        // 更新教室网格样式
        function updateClassroomGrid() {
          classroom.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
          classroom.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
          classroom.style.aspectRatio = `${cols}/${rows}`;

          // 更新滑块尺寸
          slider.style.width = `calc(${100 / cols}% - 8px)`;
          slider.style.height = `calc(${100 / rows}% - 8px)`;
        }

        // 生成座位
        function createSeats() {
          classroom.innerHTML = "";
          seats = [];
          // 不清空 skippedSeats，保持已保存的跳过状态

          // 更新网格布局
          updateClassroomGrid();

          for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
              const seat = document.createElement("div");
              seat.className = "seat";
              seat.dataset.row = row;
              seat.dataset.col = col;
              seat.textContent = `${row + 1}-${col + 1}`;
              
              // 检查是否是跳过的座位
              const index = row * cols + col;
              if (skippedSeats.has(index)) {
                seat.classList.add("skipped");
              }

              seat.addEventListener("click", () => toggleSkipSeat(seat));

              classroom.appendChild(seat);
              seats.push(seat);
            }
          }

          classroom.appendChild(slider);
          updateSliderPosition(0, 0);
        }

        // 切换跳过座位状态
        function toggleSkipSeat(seat) {
          const row = parseInt(seat.dataset.row);
          const col = parseInt(seat.dataset.col);
          const index = row * cols + col;

          if (skippedSeats.has(index)) {
            skippedSeats.delete(index);
            seat.classList.remove("skipped");
          } else {
            skippedSeats.add(index);
            seat.classList.add("skipped");
          }
          
          // 自动保存状态
          saveState();
        }

        // 更新滑块位置
        function updateSliderPosition(row, col) {
          if (currentSeat) currentSeat.classList.remove("selected");

          const seatIndex = col * cols + row;
          currentSeat = seats[seatIndex];
          slider.style.transform = `translate(${currentSeat.offsetLeft - 2}px, ${currentSeat.offsetTop - 2}px)`;
          currentSeat.classList.add("selected");

          currentSeatElement.textContent = `当前座位: ${row + 1}排${col + 1}列`;
        }

        // 获取随机座位（跳过已标记的座位）
        function getRandomSeat() {
          const availableSeats = seats
            .map((seat, index) => ({ seat, index }))
            .filter(({ index }) => !skippedSeats.has(index));

          if (availableSeats.length === 0) {
            alert("所有座位已被跳过，请重置跳过座位或取消部分跳过标记");
            return null;
          }

          const randomIndex = Math.floor(Math.random() * availableSeats.length);
          return availableSeats[randomIndex].index;
        }

        // 开始随机抽取
        function startRandomSelection() {
          if (intervalId) clearInterval(intervalId);

          intervalId = setInterval(() => {
            const randomIndex = getRandomSeat();
            if (randomIndex === null) {
              stopRandomSelection();
              return;
            }
            const col = Math.floor(randomIndex / cols);
            const row = randomIndex % cols;

            updateSliderPosition(row, col);
          }, 200);

          startBtn.disabled = true;
          stopBtn.disabled = false;
        }

        // 停止随机抽取
        function stopRandomSelection() {
          if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
          }

          startBtn.disabled = false;
          stopBtn.disabled = true;
        }

        // 重置跳过座位
        function resetSkippedSeats() {
          skippedSeats.clear();
          seats.forEach((seat) => seat.classList.remove("skipped"));
          
          // 自动保存状态
          saveState();
        }

        // 弹窗相关函数
        function openSettingsModal() {
          rowsInput.value = rows;
          colsInput.value = cols;
          settingsModal.style.display = "flex";
        }

        function closeSettingsModal() {
          settingsModal.style.display = "none";
        }

        function confirmSettingsChange() {
          const newRows = parseInt(rowsInput.value);
          const newCols = parseInt(colsInput.value);

          // 验证输入
          if (newRows < 3 || newRows > 15) {
            alert("行数必须在3-15之间");
            return;
          }

          if (newCols < 3 || newCols > 20) {
            alert("列数必须在3-20之间");
            return;
          }

          // 停止当前抽取
          if (intervalId) {
            stopRandomSelection();
          }

          // 更新尺寸并重新生成座位
          rows = newRows;
          cols = newCols;
          createSeats();
          
          // 自动保存状态
          saveState();

          closeSettingsModal();
        }

        // 初始化事件监听
        startBtn.addEventListener("click", startRandomSelection);
        stopBtn.addEventListener("click", stopRandomSelection);
        resetBtn.addEventListener("click", resetSkippedSeats);
        settingsBtn.addEventListener("click", openSettingsModal);

        // 弹窗事件监听
        closeModal.addEventListener("click", closeSettingsModal);
        cancelSettings.addEventListener("click", closeSettingsModal);
        confirmSettings.addEventListener("click", confirmSettingsChange);

        // 点击弹窗外部关闭
        settingsModal.addEventListener("click", function (e) {
          if (e.target === settingsModal) {
            closeSettingsModal();
          }
        });

        // ESC键关闭弹窗
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && settingsModal.style.display === "flex") {
            closeSettingsModal();
          }
        });

        // 初始化
        loadSavedState(); // 加载保存的状态
        createSeats();
        stopBtn.disabled = true;
      });
    </script>
  </body>
</html>
